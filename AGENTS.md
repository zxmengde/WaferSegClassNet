# AGENTS.md — MixedWM38 混合缺陷晶圆图谱：多任务识别与成分分离
面向对象：Kiro（编程+实验+写报告+写PPT）与“纯小白”用户（需要边做边教会我）

## 0. 我是谁 & 我需要什么
- 我是研究生，方向：MEMS 传感器件设计及工艺开发
- 我是编程/深度学习新手：你必须“教我”，不仅要给代码，也要解释在做什么、为什么这么做、怎么验证对不对
- 目标：在 1 周内完成《模式识别》课程实验，可复现、有对比、有消融、有图、有结论

## 1. 硬件与系统约束（请你据此选择实现）
- OS: Windows 11 (24H2)
- CPU: Intel Core Ultra 9 285H
- RAM: 32GB
- GPU: RTX 4070 SUPER 12GB
要求：
- 训练脚本必须支持 AMP（混合精度）与断点续训
- 不要把数据集提交到 git；只提交脚本与说明

## 2. 实验题目（写进报告与PPT）
晶圆工艺场景下的混合缺陷晶圆图谱多任务识别与可解释诊断：自监督表征学习 + 扩散式长尾增强 + 弱监督成分分离

## 3. 数据集与任务定义
### 3.1 主数据：MixedWM38（用于训练/测试）
任务：
- T1 分类（两条线都要支持，至少先跑通 38 类）：
  - 38 类单标签分类（1 normal + 8 single + 29 mixed）
  - 8 类基础缺陷多标签（如果原仓库支持/可构造）
- T2 缺陷定位分割：
  - 输出二值 mask（缺陷/非缺陷）
- T3 成分分离：
  - 对“混合缺陷”输出 8 通道基础缺陷热力图（弱监督，无像素级真值）

### 3.2 预训练数据：WM-811K
- 目的：用大量无标签 wafer maps 训练 encoder 表征（SimCLR 或 MoCo 风格）
- 注意：增强必须“wafer 友好”：旋转/翻转/轻微形态学噪声；避免大裁剪破坏中心/边缘语义

## 4. 我 PPT 的实验组（请你按此执行 + 输出表格）
- E0 基线：仅多任务（分类+分割），不使用 SSL/扩散/分离
- E1：E0 + SSL 预训练初始化 encoder（WM-811K）
- E2：E0 + 尾部类别加入 DDPM 生成样本（用于提升 macro-F1）
- E3：E1 + 8 通道弱监督成分分离头（要求不显著降低识别性能）

交付要求：
- 每个实验组都要：配置文件、训练命令、评估命令、结果汇总 CSV、关键可视化（混淆矩阵、mask overlay、分离热力图示例）

## 5. 指标与可视化（报告/PPT必需）
分类/多标签：
- Macro-F1（主指标）
- mAP（如果做 8 类多标签）
- confusion matrix
分割/分离：
- Dice、IoU
可解释性可视化：
- 分割：mask overlay
- 分离：8 通道热力图 + 与原图对照

## 6. 编码任务清单
### 6.1 “先跑通再变强”的最小闭环
1) Windows 环境搭建说明（conda / venv），写成 docs/SETUP_WINDOWS.md
2) 数据准备脚本与目录规范（不包含数据本体）
3) debug 模式：每类取少量样本，5 分钟内完成训练+评估闭环
4) E0：完整训练 + 保存 best checkpoint + 输出 results/
5) E1：实现 SSL 权重加载（可来自 WaPIRL 或你在仓库内实现的 SimCLR/MoCo 预训练），并完成训练对比
6) E2：扩散增强（优先只对尾部类混入生成样本）；若实现过重，降级为“类均衡采样 + 强增强 + focal/class-balanced loss”并在报告里解释取舍
7) E3：弱监督成分分离头（若实现过重，先输出“原型相似度热力图”作为弱监督可解释分离的降级版本）

### 6.2 工程化要求（必须）
- 所有训练/评估用统一入口：
  - python train.py --config configs/e0.yaml
  - python eval.py  --config configs/e0.yaml --ckpt path/to/best.pt
- 输出固定结构（用于我写报告/做PPT）：
  - results/<exp_name>/
    - metrics.csv
    - confusion_matrix.png
    - seg_overlays/
    - separation_maps/ (如果有)
    - curves/ (loss/metric)
- 训练可复现：固定 seed、记录 git commit hash、保存 config 副本

## 7. 写作交付（你必须帮我写“报告 + PPT”，且要教我）
### 7.1 实验报告（中文，建议 Markdown：report/REPORT.md）
结构必须包含：
- 摘要（我做了什么，结果如何）
- 背景与动机（工艺良率/混合缺陷挑战）
- 数据集与任务定义
- 方法（E0/E1/E2/E3）
- 实验设置（硬件、超参、训练细节）
- 结果与分析（表格 + 图）
- 消融实验（E0→E3）
- 失败与取舍（哪些没做/为何，如何替代）
- 结论与展望

你写报告时必须：
- 每一节都“先解释概念，再说明我代码怎么实现，再说明怎么验证”
- 给出“我该怎么复现实验”的命令清单

### 7.2 PPT（先给 Markdown 大纲 slides/SLIDES.md；再可选生成 pptx）
- 目标：10–12 页
- 必须包含：问题定义、数据集、方法框图、E0/E1 对比表、关键可视化（混淆矩阵/overlay/热力图）、结论
- 若你能生成 pptx：请用 python-pptx 写 scripts/build_pptx.py，并在 docs/BUILD_PPT.md 写清楚怎么生成

### 7.3 教学要求
你需要额外生成一份：
- docs/LEARNER_GUIDE.md
内容包括：
- 我每一步要运行什么命令
- 常见报错（CUDA/依赖/路径/显存）怎么排查
- 关键概念小抄：macro-F1、Dice、对比学习、长尾、弱监督
- 如何读训练日志/判断是否过拟合

## 8. 你与我协作的工作方式（请严格遵守）
- 任何时候先给“下一步最小动作”，并告诉我“运行后我应该看到什么输出”
- 你每完成一个阶段：
  1) 总结你改了哪些文件
  2) 我需要运行的命令
  3) 预期输出与验证点
  4) 如果失败，提供 3 条排查路径（按概率排序）
- 不要一次性做很大改动；以可回滚的、小步提交推进
